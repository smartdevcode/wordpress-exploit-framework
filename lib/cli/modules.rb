module Cli
  # Methods for handling commands that interact with modules.
  module Modules
    def use(module_path)
      context = Context.new
      begin
        mod = context.load_module(module_path)
        mod.event_emitter.subscribe(self)
        print_good "Loaded module: #{mod}"
        @context_stack.push(context)
      rescue StandardError => e
        print_bad "Failed to load module: #{e}"
      end
    end

    def unset(name)
      unless context
        print_bad 'No module loaded yet'
        return
      end

      context.module.unset_option(name)
      print_good "Unset #{name}"
    end

    def set(name, value)
      unless context
        print_bad 'No module loaded yet'
        return
      end

      res = context.module.set_option_value(name, value)
      if res == :not_found
        print_warning "\"#{name}\" is not a valid option"
      elsif res == :invalid
        print_bad "\"#{value}\" is not a valid value"
      else
        print_good "Set #{name} => #{res}"
      end
    end

    def run
      if context && context.module
        if context.module.run
          print_good 'Execution finished successfully'
        else
          print_bad 'Execution failed'
        end
      else
        print_warning 'No module loaded'
      end
    end
  end
end
