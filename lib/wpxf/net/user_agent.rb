module Wpxf
  module Net
    # Provides functionality for generating user agent strings.
    module UserAgent
      # Get a random browser and OS combination.
      # @return [Hash] a hash containing a :browser and :os
      def random_browser_and_os
        frequencies = clients_by_frequency
        target_frequency = rand(1..100)
        sum = 0

        frequencies.each do |browser_frequency, combinations|
          sum += browser_frequency.to_i
          next if target_frequency > sum

          # This browser encompasses our target frequency, so reset the
          # frequency sum and generate a new target frequency for the
          # operating system selection.
          target_frequency = rand(1..100)
          sum = 0

          # Once we find an OS that covers the target frequency, return
          # the browser/OS combination.
          combinations.each do |os_frequency, combo|
            sum += os_frequency.to_i
            return combo if target_frequency <= sum
          end
        end

        # This point should never be reached, as the frequencies should
        # always total 100 and thus we should always retrieve a combo.
        fail 'Browser and OS frequencies exceeded 100'
      end

      # @return [Hash] a hash of browser and OS combinations grouped by
      #   frequencies drawn from real-world statistics.
      def clients_by_frequency
        {
          34 => {
            89 => {
              browser: :chrome,
              os: :windows
            },
            9 => {
              browser: :chrome,
              os: :osx
            },
            2 => {
              browser: :chrome,
              os: :linux
            }
          },
          32 => {
            100 => {
              browser: :iexplorer,
              os: :windows
            }
          },
          25 => {
            83 => {
              browser: :firefox,
              os: :windows
            },
            16 => {
              browser: :firefox,
              os: :osx
            },
            1 => {
              browser: :firefox,
              os: :linux
            }
          },
          7 => {
            95 => {
              browser: :safari,
              os: :osx
            },
            4 => {
              browser: :safari,
              os: :windows
            },
            1 => {
              browser: :safari,
              os: :linux
            }
          },
          2 => {
            91 => {
              browser: :opera,
              os: :windows
            },
            6 => {
              browser: :opera,
              os: :linux
            },
            3 => {
              browser: :opera,
              os: :osx
            }
          }
        }
      end
    end
  end
end
